<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ–∑–∞—Ü—å–∫–∞ –ê—Ä–µ–Ω–∞ üá∫üá¶</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    html, body {
      background: linear-gradient(180deg, #4A90E2 0%, #FFE44D 100%) !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      color: #000 !important;
      min-height: 100vh;
      padding: 10px;
    }

    .container {
      max-width: 400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      padding: 15px;
      background: #ffffff !important;
      border-radius: 12px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #000 !important;
    }

    .resources {
      display: flex;
      justify-content: space-around;
      font-size: 16px;
      color: #000 !important;
      flex-wrap: wrap;
      gap: 8px;
    }

    .resources div {
      color: #000 !important;
    }

    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
      overflow-x: auto;
    }

    .tab {
      flex: 1;
      padding: 12px 8px;
      background: #e8e8e8 !important;
      border: none;
      color: #000 !important;
      font-size: 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      white-space: nowrap;
      min-width: 80px;
    }

    .tab.active {
      background: #FFD700 !important;
      color: #000 !important;
      font-weight: bold;
    }

    .screen {
      display: none;
      background: #ffffff !important;
      padding: 20px;
      border-radius: 12px;
      min-height: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .screen.active {
      display: block;
    }

    .enemy-card {
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f) !important;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .enemy-card.shake {
      animation: shake 0.3s !important;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .enemy-name {
      font-size: 22px;
      margin-bottom: 10px;
      color: #fff !important;
      font-weight: bold;
    }

    .enemy-hp {
      font-size: 28px;
      color: #fff !important;
      margin: 15px 0;
      font-weight: bold;
    }

    .enemy-level {
      font-size: 14px;
      color: #ffe0b2 !important;
    }

    .energy-bar {
      background: #e0e0e0;
      border-radius: 10px;
      height: 20px;
      margin: 15px 0;
      overflow: hidden;
      position: relative;
    }

    .energy-fill {
      background: linear-gradient(90deg, #FFD700, #FFA500);
      height: 100%;
      transition: width 0.3s;
    }

    .energy-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: bold;
      font-size: 12px;
      color: #000;
    }

    .btn {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.1s;
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn-attack {
      background: #ff5555 !important;
      color: #fff !important;
    }

    .btn-critical {
      background: #ff9500 !important;
      color: #fff !important;
    }

    .btn-block {
      background: #4A90E2 !important;
      color: #fff !important;
    }

    .btn-primary {
      background: #FFD700 !important;
      color: #000 !important;
    }

    .btn-success {
      background: #5cb85c !important;
      color: #fff !important;
    }

    .btn:disabled {
      background: #ccc !important;
      color: #666 !important;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .building {
      background: #f5f5f5 !important;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
    }

    .building-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .building-title {
      font-size: 18px;
      color: #000 !important;
      font-weight: 600;
    }

    .building-level {
      background: #FFD700 !important;
      color: #000 !important;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
    }

    .building-desc {
      font-size: 14px;
      color: #333 !important;
      margin-bottom: 10px;
    }

    .building-cost {
      font-size: 16px;
      margin-bottom: 10px;
      color: #000 !important;
      font-weight: 500;
    }

    .btn-upgrade {
      background: #5cb85c !important;
      color: #fff !important;
      padding: 10px;
      font-size: 16px;
    }

    .stats-grid {
      display: grid;
      gap: 15px;
    }

    .stat-card {
      background: #f5f5f5 !important;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #ddd;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #f39c12 !important;
      margin: 10px 0;
    }

    .stat-label {
      font-size: 14px;
      color: #333 !important;
    }

    .message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9) !important;
      color: #FFD700 !important;
      padding: 15px 30px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      z-index: 1000;
      animation: slideDown 0.3s ease;
      max-width: 90%;
    }

    @keyframes slideDown {
      from { top: -100px; opacity: 0; }
      to { top: 20px; opacity: 1; }
    }

    .lootbox {
      background: linear-gradient(135deg, #fa709a, #fee140);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .lootbox-info {
      flex: 1;
    }

    .lootbox-name {
      font-size: 18px;
      font-weight: bold;
      color: #000;
      margin-bottom: 5px;
    }

    .lootbox-desc {
      font-size: 12px;
      color: #333;
    }

    .pvp-opponent {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #ddd;
    }

    .opponent-info {
      flex: 1;
    }

    .opponent-name {
      font-size: 16px;
      font-weight: bold;
      color: #000;
      margin-bottom: 5px;
    }

    .opponent-stats {
      font-size: 12px;
      color: #666;
    }

    .info-box {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      border-left: 4px solid #2196F3;
    }

    .info-box h4 {
      color: #000;
      margin-bottom: 8px;
    }

    .info-box p {
      color: #333;
      font-size: 14px;
      line-height: 1.5;
    }

    .battle-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .battle-buttons .btn {
      font-size: 14px;
      padding: 12px;
    }

    .shield-active {
      border: 3px solid #4A90E2 !important;
      box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>‚öîÔ∏è –ö–æ–∑–∞—Ü—å–∫–∞ –ê—Ä–µ–Ω–∞</h1>
    <div class="resources">
      <div>üèÜ <span id="wins">0</span></div>
      <div>üí∞ <span id="gold">0</span></div>
      <div>‚ö° <span id="power">1</span></div>
      <div>üéÅ <span id="lootboxCount">0</span></div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('arena')">‚öîÔ∏è –ê—Ä–µ–Ω–∞</button>
    <button class="tab" onclick="switchTab('pvp')">üë• PvP</button>
    <button class="tab" onclick="switchTab('lootbox')">üé∞ –õ—É—Ç–±–æ–∫—Å</button>
    <button class="tab" onclick="switchTab('city')">üè∞ –ú—ñ—Å—Ç–æ</button>
    <button class="tab" onclick="switchTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
  </div>

  <!-- –ê–†–ï–ù–ê -->
  <div id="arena" class="screen active">
    <div class="enemy-card" id="enemyCard">
      <div class="enemy-name" id="enemyName">–ó–∞–≥–∞—Ä–±–Ω–∏–∫</div>
      <div class="enemy-level" id="enemyLevel">–†—ñ–≤–µ–Ω—å 1</div>
      <div class="enemy-hp">‚ù§Ô∏è <span id="enemyHp">20</span></div>
    </div>

    <div class="energy-bar">
      <div class="energy-fill" id="energyFill" style="width: 100%;"></div>
      <div class="energy-text">‚ö° <span id="energyText">10/10</span></div>
    </div>

    <button class="btn btn-attack" onclick="attack()">‚öîÔ∏è –£–¥–∞—Ä (<span id="damage">1</span> —à–∫–æ–¥–∏)</button>
    
    <div class="battle-buttons">
      <button class="btn btn-critical" onclick="criticalAttack()" id="critBtn">üí• –ö—Ä–∏—Ç—É–¥–∞—Ä (3‚ö°)</button>
      <button class="btn btn-block" onclick="blockAttack()" id="blockBtn">üõ°Ô∏è –ë–ª–æ–∫ (2‚ö°)</button>
    </div>
  </div>

  <!-- PVP -->
  <div id="pvp" class="screen">
    <div class="info-box">
      <h4>üë• PvP –ê—Ä–µ–Ω–∞</h4>
      <p>–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥: <strong id="pvpRating">1000</strong></p>
      <p>–ü–µ—Ä–µ–º–æ–≥: <strong id="pvpWins">0</strong> | –ü—Ä–æ–≥—Ä–∞—à—ñ–≤: <strong id="pvpLosses">0</strong></p>
    </div>
    <div id="pvpList"></div>
  </div>

  <!-- –õ–£–¢–ë–û–ö–° -->
  <div id="lootbox" class="screen">
    <div class="info-box">
      <h4>üé∞ –õ—É—Ç–±–æ–∫—Å–∏</h4>
      <p>–í—ñ–¥–∫—Ä–∏—Ç–æ –ª—É—Ç–±–æ–∫—Å—ñ–≤: <strong id="lootboxesOpened">0</strong></p>
    </div>
    
    <div class="lootbox">
      <div class="lootbox-info">
        <div class="lootbox-name">üì¶ –ó–≤–∏—á–∞–π–Ω–∏–π</div>
        <div class="lootbox-desc">üí∞ 20-50 –∑–æ–ª–æ—Ç–∞, üéÅ –º–æ–∂–ª–∏–≤—ñ —Å—é—Ä–ø—Ä–∏–∑–∏</div>
      </div>
      <button class="btn btn-primary" style="width: auto; padding: 10px 20px; margin: 0;" onclick="openLootbox('common')">50üí∞</button>
    </div>

    <div class="lootbox">
      <div class="lootbox-info">
        <div class="lootbox-name">üéÅ –†—ñ–¥–∫—ñ—Å–Ω–∏–π</div>
        <div class="lootbox-desc">üí∞ 50-150 –∑–æ–ª–æ—Ç–∞, ‚ö° +1 —Å–∏–ª–∞</div>
      </div>
      <button class="btn btn-primary" style="width: auto; padding: 10px 20px; margin: 0;" onclick="openLootbox('rare')">150üí∞</button>
    </div>

    <div class="lootbox">
      <div class="lootbox-info">
        <div class="lootbox-name">üíé –ï–ø—ñ—á–Ω–∏–π</div>
        <div class="lootbox-desc">üí∞ 200-500 –∑–æ–ª–æ—Ç–∞, ‚ö° +2 —Å–∏–ª–∞</div>
      </div>
      <button class="btn btn-primary" style="width: auto; padding: 10px 20px; margin: 0;" onclick="openLootbox('epic')">500üí∞</button>
    </div>
  </div>

  <!-- –ú–Ü–°–¢–û -->
  <div id="city" class="screen">
    <div class="building">
      <div class="building-header">
        <div class="building-title">‚öîÔ∏è –ö—É–∑–Ω—è</div>
        <div class="building-level">–†—ñ–≤–µ–Ω—å <span id="forgeLevel">1</span></div>
      </div>
      <div class="building-desc">–ó–±—ñ–ª—å—à—É—î —Å–∏–ª—É –∞—Ç–∞–∫–∏ –Ω–∞ +1</div>
      <div class="building-cost">üí∞ –í–∞—Ä—Ç—ñ—Å—Ç—å: <span id="forgeCost">50</span></div>
      <button class="btn btn-upgrade" onclick="upgradeBuilding('forge')" id="forgeBtn">–ü–æ–∫—Ä–∞—â–∏—Ç–∏</button>
    </div>

    <div class="building">
      <div class="building-header">
        <div class="building-title">üí∞ –°–∫–∞—Ä–±–Ω–∏—Ü—è</div>
        <div class="building-level">–†—ñ–≤–µ–Ω—å <span id="treasuryLevel">1</span></div>
      </div>
      <div class="building-desc">+10 –∑–æ–ª–æ—Ç–∞ –∑–∞ –ø–µ—Ä–µ–º–æ–≥—É</div>
      <div class="building-cost">üí∞ –í–∞—Ä—Ç—ñ—Å—Ç—å: <span id="treasuryCost">100</span></div>
      <button class="btn btn-upgrade" onclick="upgradeBuilding('treasury')" id="treasuryBtn">–ü–æ–∫—Ä–∞—â–∏—Ç–∏</button>
    </div>

    <div class="building">
      <div class="building-header">
        <div class="building-title">üè∞ –§–æ—Ä—Ç–µ—Ü—è</div>
        <div class="building-level">–†—ñ–≤–µ–Ω—å <span id="fortressLevel">1</span></div>
      </div>
      <div class="building-desc">–í—ñ–¥–∫—Ä–∏–≤–∞—î —Å–∏–ª—å–Ω—ñ—à–∏—Ö –≤–æ—Ä–æ–≥—ñ–≤</div>
      <div class="building-cost">üí∞ –í–∞—Ä—Ç—ñ—Å—Ç—å: <span id="fortressCost">200</span></div>
      <button class="btn btn-upgrade" onclick="upgradeBuilding('fortress')" id="fortressBtn">–ü–æ–∫—Ä–∞—â–∏—Ç–∏</button>
    </div>

    <div class="building">
      <div class="building-header">
        <div class="building-title">‚ö° –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</div>
        <div class="building-level">–†—ñ–≤–µ–Ω—å <span id="generatorLevel">1</span></div>
      </div>
      <div class="building-desc">+2 –¥–æ –º–∞–∫—Å. –µ–Ω–µ—Ä–≥—ñ—ó</div>
      <div class="building-cost">üí∞ –í–∞—Ä—Ç—ñ—Å—Ç—å: <span id="generatorCost">150</span></div>
      <button class="btn btn-upgrade" onclick="upgradeBuilding('generator')" id="generatorBtn">–ü–æ–∫—Ä–∞—â–∏—Ç–∏</button>
    </div>
  </div>

  <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
  <div id="stats" class="screen">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">–í—Å—å–æ–≥–æ –ø–µ—Ä–µ–º–æ–≥</div>
        <div class="stat-value" id="totalWins">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">–ó–∞—Ä–æ–±–ª–µ–Ω–æ –∑–æ–ª–æ—Ç–∞</div>
        <div class="stat-value" id="totalGold">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">–ü–æ—Ç–æ—á–Ω–∞ —Å–∏–ª–∞</div>
        <div class="stat-value" id="totalPower">1</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">–í—ñ–¥–∫—Ä–∏—Ç–æ –ª—É—Ç–±–æ–∫—Å—ñ–≤</div>
        <div class="stat-value" id="totalLootboxes">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">PvP —Ä–µ–π—Ç–∏–Ω–≥</div>
        <div class="stat-value" id="statPvpRating">1000</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">–ö—Ä–∏—Ç–∏—á–Ω–∏—Ö —É–¥–∞—Ä—ñ–≤</div>
        <div class="stat-value" id="totalCrits">0</div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="resetProgress()" style="margin-top: 20px;">üîÑ –°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å</button>
  </div>
</div>

<script>
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  const enemies = [
    { name: "–ó–∞–≥–∞—Ä–±–Ω–∏–∫", hp: 20, gold: 10, level: 1, damage: 2 },
    { name: "–í–æ—è–∫", hp: 35, gold: 20, level: 2, damage: 4 },
    { name: "–û–ø—Ä–∏—á–Ω–∏–∫", hp: 60, gold: 35, level: 3, damage: 6 },
    { name: "–®–ª—è—Ö—Ç–∏—á", hp: 100, gold: 60, level: 4, damage: 10 },
    { name: "–ë–æ—è—Ä–∏–Ω", hp: 150, gold: 100, level: 5, damage: 15 },
    { name: "–í–æ—î–≤–æ–¥–∞", hp: 250, gold: 180, level: 6, damage: 22 },
    { name: "–ì–µ–Ω–µ—Ä–∞–ª", hp: 400, gold: 300, level: 7, damage: 30 }
  ];

  let gameState = {
    wins: 0,
    gold: 0,
    totalGold: 0,
    power: 1,
    currentEnemy: 0,
    enemyHp: 20,
    energy: 10,
    maxEnergy: 10,
    isBlocking: false,
    buildings: { forge: 1, treasury: 1, fortress: 1, generator: 1 },
    lootboxesOpened: 0,
    pvpRating: 1000,
    pvpWins: 0,
    pvpLosses: 0,
    totalCrits: 0
  };

  // –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –µ–Ω–µ—Ä–≥—ñ—ó
  setInterval(() => {
    if (gameState.energy < gameState.maxEnergy) {
      gameState.energy++;
      updateUI();
      saveGame();
    }
  }, 5000); // –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥ +1 –µ–Ω–µ—Ä–≥—ñ—è

  function loadGame() {
    if (tg.CloudStorage) {
      tg.CloudStorage.getItem('gameState', (err, data) => {
        if (data) {
          gameState = {...gameState, ...JSON.parse(data)};
          spawnEnemy();
          updateUI();
        } else {
          spawnEnemy();
        }
      });
    } else {
      const saved = localStorage.getItem('kozakGame');
      if (saved) {
        gameState = {...gameState, ...JSON.parse(saved)};
        spawnEnemy();
      }
      updateUI();
    }
  }

  function saveGame() {
    const data = JSON.stringify(gameState);
    if (tg.CloudStorage) {
      tg.CloudStorage.setItem('gameState', data);
    } else {
      localStorage.setItem('kozakGame', data);
    }
  }

  function spawnEnemy() {
    const maxLevel = Math.min(gameState.buildings.fortress, enemies.length - 1);
    gameState.currentEnemy = Math.floor(Math.random() * (maxLevel + 1));
    const enemy = enemies[gameState.currentEnemy];
    gameState.enemyHp = enemy.hp;
    gameState.isBlocking = false;
    
    const card = document.getElementById('enemyCard');
    card.classList.remove('shield-active');
  }

  function attack() {
    if (gameState.energy < 1) {
      showMessage('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –µ–Ω–µ—Ä–≥—ñ—ó!');
      return;
    }

    gameState.energy -= 1;
    gameState.enemyHp -= gameState.power;
    
    if (tg.HapticFeedback) {
      tg.HapticFeedback.impactOccurred("medium");
    }

    const card = document.getElementById('enemyCard');
    card.classList.add('shake');
    setTimeout(() => card.classList.remove('shake'), 300);

    if (gameState.enemyHp <= 0) {
      victory();
    } else {
      enemyAttack();
    }

    updateUI();
    saveGame();
  }

  function criticalAttack() {
    if (gameState.energy < 3) {
      showMessage('‚ùå –ü–æ—Ç—Ä—ñ–±–Ω–æ 3 –µ–Ω–µ—Ä–≥—ñ—ó!');
      if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred("error");
      return;
    }

    gameState.energy -= 3;
    const damage = gameState.power * 3;
    gameState.enemyHp -= damage;
    gameState.totalCrits++;
    
    showMessage(`üí• –ö—Ä–∏—Ç—É–¥–∞—Ä! ${damage} —à–∫–æ–¥–∏!`);
    
    if (tg.HapticFeedback) {
      tg.HapticFeedback.impactOccurred("heavy");
    }

    const card = document.getElementById('enemyCard');
    card.classList.add('shake');
    setTimeout(() => card.classList.remove('shake'), 300);

    if (gameState.enemyHp <= 0) {
      victory();
    } else {
      enemyAttack();
    }

    updateUI();
    saveGame();
  }

  function blockAttack() {
    if (gameState.energy < 2) {
      showMessage('‚ùå –ü–æ—Ç—Ä—ñ–±–Ω–æ 2 –µ–Ω–µ—Ä–≥—ñ—ó!');
      if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred("error");
      return;
    }

    gameState.energy -= 2;
    gameState.isBlocking = true;
    
    showMessage('üõ°Ô∏è –ë–ª–æ–∫ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ!');
    
    if (tg.HapticFeedback) {
      tg.HapticFeedback.impactOccurred("light");
    }

    const card = document.getElementById('enemyCard');
    card.classList.add('shield-active');

    setTimeout(() => {
      gameState.isBlocking = false;
      card.classList.remove('shield-active');
    }, 3000);

    updateUI();
    saveGame();
  }

  function enemyAttack() {
    setTimeout(() => {
      const enemy = enemies[gameState.currentEnemy];
      let damage = enemy.damage;
      
      if (gameState.isBlocking) {
        damage = Math.floor(damage * 0.5);
        showMessage(`üõ°Ô∏è –ë–ª–æ–∫–æ–≤–∞–Ω–æ! –õ–∏—à–µ ${damage} —à–∫–æ–¥–∏`);
        gameState.isBlocking = false;
        document.getElementById('enemyCard').classList.remove('shield-active');
      }

      // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –∑–º–µ–Ω—à–µ–Ω–Ω—è HP –≥—Ä–∞–≤—Ü—è, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
      
      updateUI();
    }, 800);
  }

  function victory() {
    const enemy = enemies[gameState.currentEnemy];
    const goldReward = enemy.gold + (gameState.buildings.treasury - 1) * 10;
    
    gameState.wins++;
    gameState.gold += goldReward;
    gameState.totalGold += goldReward;

    showMessage(`üèÜ –ü–µ—Ä–µ–º–æ–≥–∞! +${goldReward} üí∞`);
    
    if (tg.HapticFeedback) {
      tg.HapticFeedback.notificationOccurred("success");
    }

    spawnEnemy();
  }

  function upgradeBuilding(type) {
    const costs = {
      forge: 50 * gameState.buildings.forge,
      treasury: 100 * gameState.buildings.treasury,
      fortress: 200 * gameState.buildings.fortress,
      generator: 150 * gameState.buildings.generator
    };

    const cost = costs[type];

    if (gameState.gold >= cost) {
      gameState.gold -= cost;
      gameState.buildings[type]++;

      if (type === 'forge') {
        gameState.power = gameState.buildings.forge;
      } else if (type === 'generator') {
        gameState.maxEnergy = 10 + (gameState.buildings.generator - 1) * 2;
        gameState.energy = gameState.maxEnergy;
      }

      showMessage(`‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–æ!`);
      
      if (tg.HapticFeedback) {
        tg.HapticFeedback.notificationOccurred("success");
      }
      
      updateUI();
      saveGame();
    } else {
      showMessage(`‚ùå –ù–µ –≤–∏—Å—Ç–∞—á–∞—î –∑–æ–ª–æ—Ç–∞`);
      
      if (tg.HapticFeedback) {
        tg.HapticFeedback.notificationOccurred("error");
      }
    }
  }

  function openLootbox(type) {
    const prices = { common: 50, rare: 150, epic: 500 };
    const price = prices[type];

    if (gameState.gold < price) {
      showMessage('‚ùå –ù–µ –≤–∏—Å—Ç–∞—á–∞—î –∑–æ–ª–æ—Ç–∞');
      if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred("error");
      return;
    }

    gameState.gold -= price;
    gameState.lootboxesOpened++;

    let reward = '';
    let goldAmount = 0;

    if (type === 'common') {
      goldAmount = Math.floor(Math.random() * 31) + 20;
      gameState.gold += goldAmount;
      reward = `üí∞ ${goldAmount} –∑–æ–ª–æ—Ç–∞`;
    } else if (type === 'rare') {
      goldAmount = Math.floor(Math.random() * 101) + 50;
      gameState.gold += goldAmount;
      gameState.power += 1;
      reward = `üí∞ ${goldAmount} –∑–æ–ª–æ—Ç–∞ + ‚ö° +1 —Å–∏–ª–∞`;
    } else if (type === 'epic') {
      goldAmount = Math.floor(Math.random() * 301) + 200;
      gameState.gold += goldAmount;
      gameState.power += 2;
      reward = `üí∞ ${goldAmount} –∑–æ–ª–æ—Ç–∞ + ‚ö° +2 —Å–∏–ª–∞`;
    }

    showMessage(`üéÅ –û—Ç—Ä–∏–º–∞–Ω–æ: ${reward}`);
    
    if (tg.HapticFeedback) {
      tg.HapticFeedback.notificationOccurred("success");
    }

    updateUI();
    saveGame();
  }

  function renderPvP() {
    const container = document.getElementById('pvpList');
    let html = '';

    for (let i = 0; i < 5; i++) {
      const ratingDiff = Math.floor(Math.random() * 200) - 100;
      const opponentRating = Math.max(800, gameState.pvpRating + ratingDiff);
      const opponentPower = Math.max(1, Math.floor(opponentRating / 150));
      const name = `–ö–æ–∑–∞–∫ ${Math.floor(Math.random() * 1000)}`;

      html += `
        <div class="pvp-opponent">
          <div class="opponent-info">
            <div class="opponent-name">‚öîÔ∏è ${name}</div>
            <div class="opponent-stats">–†–µ–π—Ç–∏–Ω–≥: ${opponentRating} | –°–∏–ª–∞: ${opponentPower}</div>
          </div>
          <button class="btn btn-success" style="width: auto; padding: 10px 20px; margin: 0;" onclick="startPvP(${opponentPower}, ${opponentRating})">–ë–∏—Ç–≤–∞</button>
        </div>
      `;
    }

    container.innerHTML = html;
  }

  function startPvP(opponentPower, opponentRating) {
    const myPower = gameState.power;
    const winChance = myPower / (myPower + opponentPower);
    const won = Math.random() < winChance;

    if (won) {
      gameState.pvpWins++;
      gameState.pvpRating += 10;
      gameState.gold += 50;
      showMessage('üèÜ –ü–µ—Ä–µ–º–æ–≥–∞ –≤ PvP! +50üí∞, +10 —Ä–µ–π—Ç–∏–Ω–≥—É');
      if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred("success");
    } else {
      gameState.pvpLosses++;
      gameState.pvpRating = Math.max(800, gameState.pvpRating - 5);
      showMessage('üòî –ü–æ—Ä–∞–∑–∫–∞ –≤ PvP. -5 —Ä–µ–π—Ç–∏–Ω–≥—É');
      if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred("error");
    }

    updateUI();
    renderPvP();
    saveGame();
  }

  function updateUI() {
    const enemy = enemies[gameState.currentEnemy];

    document.getElementById('wins').textContent = gameState.wins;
    document.getElementById('gold').textContent = gameState.gold;
    document.getElementById('power').textContent = gameState.power;
    document.getElementById('damage').textContent = gameState.power;
    document.getElementById('lootboxCount').textContent = gameState.lootboxesOpened;

    document.getElementById('enemyName').textContent = enemy.name;
    document.getElementById('enemyLevel').textContent = `–†—ñ–≤–µ–Ω—å ${enemy.level}`;
    document.getElementById('enemyHp').textContent = gameState.enemyHp;

    // –ï–Ω–µ—Ä–≥—ñ—è
    document.getElementById('energyText').textContent = `${gameState.energy}/${gameState.maxEnergy}`;
    const energyPercent = (gameState.energy / gameState.maxEnergy) * 100;
    document.getElementById('energyFill').style.width = `${energyPercent}%`;

    // –ö–Ω–æ–ø–∫–∏ –∞—Ç–∞–∫
    document.getElementById('critBtn').disabled = gameState.energy < 3;
    document.getElementById('blockBtn').disabled = gameState.energy < 2;

    // –ë—É–¥—ñ–≤–ª—ñ
    document.getElementById('forgeLevel').textContent = gameState.buildings.forge;
    document.getElementById('forgeCost').textContent = 50 * gameState.buildings.forge;
    document.getElementById('forgeBtn').disabled = gameState.gold < 50 * gameState.buildings.forge;

    document.getElementById('treasuryLevel').textContent = gameState.buildings.treasury;
    document.getElementById('treasuryCost').textContent = 100 * gameState.buildings.treasury;
    document.getElementById('treasuryBtn').disabled = gameState.gold < 100 * gameState.buildings.treasury;

    document.getElementById('fortressLevel').textContent = gameState.buildings.fortress;
    document.getElementById('fortressCost').textContent = 200 * gameState.buildings.fortress;
    document.getElementById('fortressBtn').disabled = gameState.gold < 200 * gameState.buildings.fortress || gameState.buildings.fortress >= enemies.length;

    document.getElementById('generatorLevel').textContent = gameState.buildings.generator;
    document.getElementById('generatorCost').textContent = 150 * gameState.buildings.generator;
    document.getElementById('generatorBtn').disabled = gameState.gold < 150 * gameState.buildings.generator;

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    document.getElementById('totalWins').textContent = gameState.wins;
    document.getElementById('totalGold').textContent = gameState.totalGold;
    document.getElementById('totalPower').textContent = gameState.power;
    document.getElementById('totalLootboxes').textContent = gameState.lootboxesOpened;
    document.getElementById('lootboxesOpened').textContent = gameState.lootboxesOpened;
    document.getElementById('pvpRating').textContent = gameState.pvpRating;
    document.getElementById('pvpWins').textContent = gameState.pvpWins;
    document.getElementById('pvpLosses').textContent = gameState.pvpLosses;
    document.getElementById('statPvpRating').textContent = gameState.pvpRating;
    document.getElementById('totalCrits').textContent = gameState.totalCrits;
  }

  function switchTab(tab) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    
    document.getElementById(tab).classList.add('active');
    event.target.classList.add('active');

    if (tab === 'pvp') renderPvP();
  }

  function showMessage(text) {
    const msg = document.createElement('div');
    msg.className = 'message';
    msg.textContent = text;
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 2000);
  }

  function resetProgress() {
    if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å –±—É–¥–µ –≤—Ç—Ä–∞—á–µ–Ω–æ!')) {
      gameState = {
        wins: 0,
        gold: 0,
        totalGold: 0,
        power: 1,
        currentEnemy: 0,
        enemyHp: 20,
        energy: 10,
        maxEnergy: 10,
        isBlocking: false,
        buildings: { forge: 1, treasury: 1, fortress: 1, generator: 1 },
        lootboxesOpened: 0,
        pvpRating: 1000,
        pvpWins: 0,
        pvpLosses: 0,
        totalCrits: 0
      };
      spawnEnemy();
      updateUI();
      saveGame();
      showMessage('üîÑ –ü—Ä–æ–≥—Ä–µ—Å —Å–∫–∏–Ω—É—Ç–æ');
    }
  }

  loadGame();
</script>

</body>
</html>